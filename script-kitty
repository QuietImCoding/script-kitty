#!/bin/bash

_find_repo_name() {
    echo "$1" | rev | cut -d'/' -f1 | rev
}

_find_bash_config() {
    if [[ -f ~/.bash_profile ]]; then echo "$HOME/.bash_profile";
    else echo "$HOME/.bashrc"; fi
}

_kitty_install() {
    conf=$(_find_bash_config)
    if grep -q "SCRIPT_KITTY_MAGIC_YARNBALL" $conf; then
	echo "Set up script-kitty!"
    else
	KITTY_HOME="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
	export KITTY_HOME
	echo "## SCRIPT_KITTY_MAGIC_YARNBALL ##" >> $conf
	echo "export KITTY_HOME=$KITTY_HOME" >> $conf
	read -p "Kitty needs a github: " KITTY_USER
	echo "export KITTY_USER=$KITTY_USER" >> $conf
	echo "source $KITTY_HOME/script-kitty" >> $conf
	echo "## END_MAGIC_YARNBALL ##" >> $conf
	touch "$KITTY_HOME/.kitty_yarn"
	mkdir "$KITTY_HOME/yarn_pile"
    fi
}

_kitty_pull() {
    echo "Kitty is tugging on loose ends..."
    conf="$(_find_bash_config)"
    for yarnball in $(cat "$KITTY_HOME/.kitty_yarn"); do
	cleaned_yarn="$(_find_repo_name $yarnball)"
	yarn_dir="$KITTY_HOME/yarn_pile/$cleaned_yarn"
	if [[ -d "$yarn_dir" ]]; then
	    owd=$(pwd)
	    cd "$yarn_dir" || continue
	    git pull &>/dev/null
	    cd $owd
	    echo " - Updated $yarnball"
	else
	    owd=$(pwd)
	    kitty_end="## END_MAGIC_YARNBALL ##"
	    src_yarn="source $KITTY_HOME/yarn_pile/$cleaned_yarn/$cleaned_yarn"

	    cd "$KITTY_HOME/yarn_pile" || continue
	    if echo "$yarnball" | grep -q '/'; then
		git clone "https://github.com/$yarnball" &>"$KITTY_HOME/.catlog" ||
		    echo " - Kitty could not find '$yarnball' *sad kitty*"
	    else
		git clone "https://github.com/$KITTY_USER/$yarnball" &>"$KITTY_HOME/.kittylog" ||
		    echo " - Kitty could not find '$yarnball' *sad kitty*"
	    fi
	    cd $owd
	    # This statement is so janky but MacOS sed is terrible
	    # and I don't want to do different things depending on the sed version
	    
	    sed -i '' "s:$kitty_end:$src_yarn\\$(printf '\n')
$kitty_end:g" $conf
	    echo " - Kitty grabbed $yarnball"
	fi
    done
}

_kitty_remove() {
    if grep -q "$1" "$KITTY_HOME/.kitty_yarn"; then
	conf="$(_find_bash_config)"
	cleaned_yarn="$(_find_repo_name $1)"
	grep -v "$cleaned_yarn" "$KITTY_HOME/.kitty_yarn" > .tempkitty &&
	    mv .tempkitty "$KITTY_HOME/.kitty_yarn"
	grep -v "$KITTY_HOME/yarn_pile/$cleaned_yarn" "$conf" > .tempkitty &&
	    mv .tempkitty "$conf"
	
	if [[ -d "$KITTY_HOME/yarn_pile/$cleaned_yarn" ]]; then
	    rm -rf "$KITTY_HOME/yarn_pile/$cleaned_yarn"
	fi
	echo "Kitty threw $1 out the window"
    else
	echo "Kitty couldn't find $1.... Kitty is confused"
    fi
}

_kitty_list() {
    echo "Your kitty has the following yarn balls:"
    for l in $(cat $KITTY_HOME/.kitty_yarn); do
	echo " - $l"
    done
}


_kitty_add() {
    if $(grep -q $1 "$KITTY_HOME/.kitty_yarn"); then
	echo "Yarnball already installed!!"
    else
	echo $1 >> "$KITTY_HOME/.kitty_yarn"
	echo "Added yarnball $1"
    fi
}

_kitty_update() {
    source "$KITTY_HOME/script-kitty"
    echo "Updated script-kitty!!"
}

kitty() {
    cmd=$1
    shift
    case $cmd in
	'add') 	_kitty_add $@;;
	'remove') _kitty_remove $@;;
	'list') _kitty_list $@;;
	'pull') _kitty_pull $@;;
	'update') _kitty_update $@;;	
	'install') _kitty_install $@;;
    esac
}
